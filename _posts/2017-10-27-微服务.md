---
layout:     post
title:      Spring boot 集成 Thrift 和 Zookeeper 建立微服务
subtitle:   基于 Spring boot框架，使用 Thrift 通信实现微服务，并通过 Zookeeper 进行服务治理
date:       2017-10-27
author:     uncledrew
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Spring boot
    - Thrift
    - Zookeeper
    - 微服务
    - 服务治理
---

> 纸上得来终觉浅，绝知此事要躬行。
>
> [我的博客](http://uncledrewzhu.github.io/)

# 技术简介

#### Spring boot

优势：
- 简化新项目的初始搭建和开发过程
- 内嵌 Tomcat，无需部署WAR包
- 简化 Maven 配置
- 简化复杂的 XML 文件配置
- 自动配置 Spring

所以使用轻量级的 Spring boot 构建微服务是基础，也可以说是它的先天优势。

#### Thrift
Thrift 是 Facebook 公布的一款可扩展的跨语言服务开发的软件框架。

下面是引用网上的一段解释：
> 什么是RPC框架?

> RPC全称为Remote Procedure Call,意为远程过程调用.

> 假设有两台服务器A,B.A服务器上部署着一个应用a,B服务器上部署着一个应用b,现在a希望能够调用b应用的某个函数(方法),
但是二者不在同一个进程内,不能直接调用,就需要通过网络传输,在AB服务器之间建一条网络传输通道,a把参数传过去,
b接收到参数调用自己的方法,得到结果,再通过网络传回给a,简单讲就是A通过网络来调用B的过程.这个过程要涉及的东西很多,
比如多线程,Socket,序列化反序列化,网络I/O,很复杂,于是牛掰的程序员把这些封装起来做成一套框架,供大家使用,就是RPC框架.

> thrift的跨语言特型

> thrift通过一个中间语言IDL(接口定义语言)来定义RPC的数据类型和接口,这些内容写在以.thrift结尾的文件中,
然后通过特殊的编译器来生成不同语言的代码,以满足不同需要的开发者,比如java开发者,就可以生成java代码,
c++开发者可以生成c++代码,生成的代码中不但包含目标语言的接口定义,方法,数据类型,还包含有RPC协议层和传输层的实现代码.

#### Zookeeper
ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务。

ZooKeeper 封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。

ZooKeeper 主要提供的功能：
- 配置维护
- 域名服务
- 分布式同步
- 组服务等

这里，我们是通过 Zookeeper 进行服务注册、服务发现和服务治理。

如图：
![](http://oxy6ml8al.bkt.clouddn.com/microservice-zookeeper.jpg)

本地如果想要搭建一个 Zookeeper 服务，可以使用 Docker 快速启动。我用的是 [wurstmeister/zookeeper](https://hub.docker.com/r/wurstmeister/zookeeper/) 这个镜像。

# 微服务案例[后端应用在`filter`中通过`kafka`生产`http`报文日志，用于行为分析]

#### 使用 Thrift 定义接口协议
1. 定义接口协议文件 `KafkaProducerService.thrift`

 ```
 namespace java kafka.producer.service
 
 struct MessageSendBean {
   1: string topic
   2: string message
 }
  
 service KafkaProducerService {
   void sendMessageToKafka(1:MessageSendBean messageSendBean)
 }
 ```
 
2. 终端进入文件所在目录,执行命令:
 
 ```
 thrift -r -gen java KafkaProducerService.thrift
```

会生成一个 gen-java 的目录，里面有 `MessageSendBean.java` 和 `KafkaProducerService.java` 两个文件。
包含接口定义 KafkaProducerService.Iface，以及服务调用的底层通信细节。
包括客户端的调用逻辑 KafkaProducerService.Client 以及服务端的处理逻辑 KafkaProducerService.Processor。

3. 创建一个声明所有 thrift 接口的 maven 项目，取名`thrift-interface`，在 pom.xml 文件中添加依赖

```
<dependency>
    <groupId>org.apache.thrift</groupId>
    <artifactId>libthrift</artifactId>
    <version>0.9.3</version>
</dependency>
```

并且将 gen-java 的目录下的文件放到项目中。

4. 打包，上传到 本地私服 nexus 中。
```
    $ maven package
    $ mvn deploy:deploy-file -DgroupId=com.lfzhu -DartifactId=thrift-interface -Dversion=0.0.1 -Dpackaging=jar -Dfile=target/thrift-interface-0.0.1.jar -DpomFile=pom.xml -Durl=http://host:port/repository/maven-releases -DrepositoryId=nexus
```

#### 定义 Thrift 和 Zookeeper 服务工厂




# 参考
[Building Apache Thrift on CentOS](https://thrift.apache.org/docs/install/centos)

[Building Apache Thrift on CentOS (简书)](http://www.jianshu.com/p/08c5d24656ae)

[Thrift入门初探](http://www.cnblogs.com/fingerboy/p/6424248.html)

[Writing a .thrift file](http://thrift-tutorial.readthedocs.io/en/latest/thrift-file.html)

[基于Zookeeper的服务注册与发现 ](https://tech.imdada.cn/2015/12/03/service-registry-and-discovery-with-zk/)

[](http://www.cnblogs.com/skyblog/p/5535418.html)

[Apache Helix简介](http://blog.csdn.net/oopsoom/article/details/47416575)
