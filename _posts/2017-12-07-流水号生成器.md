---
layout:     post
title:      流水号生成器
subtitle:   通过简单的配置来生成满足不同需求的流水号格式
date:       2017-12-07
author:     uncledrew
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - SpringBoot
    - Mybatis
    - Redis
    - 流水号
    - 悲观锁
---

> 纸上得来终觉浅，绝知此事要躬行。
>
> [我的博客](http://uncledrew.405go.cn/)


# 前言
根据不同的业务需求和业务对象，通过流水号标识其唯一性。其中流水号的特性需要考虑：
- 连续性/无序性
- 支持并发读取并保持有序
- 支持批量读取
- 支持不同格式的表现

# 生成策略
#### 无序的流水号
- 通过 uuid 生成

#### 有序的流水号
- 通过系统的纳秒生成
- 通过设定的模板(如0000)自动递增生成：0001,0002,0003

#### 有序并且带日期格式的流水号
- 根据按年/月/日循环自动递增生成:201801010001，201801010002.201801010003，201801020001，201801020002

#### 流水号生成后支持重新包装
- 提供后置处理器对生成的流水号二次加工:例如在学生编号前面拼接上其所属导师的编号，TH0001-STD0001，TH0001-STD0002，TH0001-STD0003

# 实现
#### 流水号选择器
流水号选择器是用于根据配置的参数，利用 Spring bean 的自动装配功能，获取对应的流水号生成器（SerialNoGenerator）。
其中核心代码如下：
```
public SerialNoGenerator find(String generatorId) {
        String beanName = generatorMap.get(generatorId);
        SerialNoGenerator generator = null;
        if (StringUtils.isNotBlank(beanName)) {
            generator = ApplicationContextHolder.getBean(beanName, SerialNoGenerator.class);
        }
        if (generator == null) {
            generator = ApplicationContextHolder.getBean("DEFAULT", SerialNoGenerator.class);
        }
        return generator;
    }
```

generatorMap 是 Spring boot 配置文件映射出来的 ConfigurationProperties，配置文件 application.yaml 内容如下：
```
generator-map:
    "table1.column1": "DEFAULT"
    "table2.column2": "UUID"
    "table3.column3": "WITH_DATE_YMD_CYCLE_BY_YMD"
```

#### 流水号生成器
