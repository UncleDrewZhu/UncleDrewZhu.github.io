---
layout:     post
title:      Web 项目安全机制和权限管理
subtitle:   Web 项目中用户安全策略和权限管理的实现过程
date:       2017-10-25
author:     uncledrew
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Web
    - Token
    - 加密
    - 权限
    - 安全
---

> 纸上得来终觉浅，绝知此事要躬行。
>
> [我的博客](http://uncledrewzhu.github.io/)

# 一次请求在服务器端的校验过程

![](http://oxy6ml8al.bkt.clouddn.com/secrity-flow.png)
当一个外部请求发给服务器端，首先经过过滤器进行行为采集，然后经过拦截器进行身份验证，最后经过控制层、服务层、数据层根据用户的权限获取对应的数据。

# 过滤器行为采集
![](http://oxy6ml8al.bkt.clouddn.com/secrity-filter.png)
将请求路径，请求参数，请求体，头部信息，ip地址，端口，用户部门等信息记录到日志系统中，可以对用户进行行为分析。

# 拦截器身份验证
![](http://oxy6ml8al.bkt.clouddn.com/secrity-interceptor.png)
1. 验证用户请求头部信息是否合法，如果不合法，则抛出异常。
2. 验证用户登录时获取到的请求令牌(token)是否合法，如果不合法，则抛出异常。
3. 验证用户发起请求时的主机地址，防止 token 被窃取。如果请求的主机地址与登录时获取 token 时的主机地址不匹配，则抛出异常。
4. 验证用户状态，防止用户登录后被删除或者被冻结后还能访问服务器。如果此时用户状态不合法，则抛出异常。

# 数据加密方式
![](http://oxy6ml8al.bkt.clouddn.com/secrity-encrypt.png)
加密方式是如何进化的：
- 可逆加密：点点鼠标，轻轻松松就可破解
- 简单的不可逆加密：彩虹库 + 超强的 GPU 运算能力 = 暴力破解
- HASH 加密：
    - 一次 MD5
    - 将密码与一个随机字符串进行一次 MD5
    - 两次 MD5：使用一个随机字符串与密码的 MD5 值再进行一次 MD5
    - HS256：用于 [JWT(JSON Web Token)](https://en.wikipedia.org/wiki/JSON_Web_Token)，使用 HMAC-SHA256 签名，进行加密
    - [PBKDF2](https://en.wikipedia.org/wiki/PBKDF2)：使用 SHA(SHA1、SHA256) 签名配合 SALT 值，再配合 10000 次运算，进行加密

# 用户权限管理
![](http://oxy6ml8al.bkt.clouddn.com/secrity-privilege.png)

#### 定义菜单服务
元数据定义平台上会定义一个应用涉及的所有服务，标记其中的主菜单服务。

#### 定义菜单
针对所有的主菜单服务，可以自由组合，生成一份菜单JSON文件。

#### 定义权限
针对所有的主菜单服务，为每个服务提供六种权限，可在`SSO`应用上查看所有应用的所有权限
- 读写-用户范围
- 读写-部门范围
- 读写-全局范围
- 只读-用户范围
- 只读-部门范围
- 只读-全局范围

#### 定义特殊权限
元数据定义平台上可以定义一些特殊权限。

比如流程审批某个申请对象基本信息页面，一般都是只读权限，但是到了某个流程节点，
可以对申请对象基本信息中的某几个字段进行编辑操作，此时配置特殊权限即可。

特殊权限主要是针对某个服务下的按钮和字段。

#### 定义角色以及角色对应的权限
根据不用租户的组织架构，定义基础角色，并且将每个角色对应的权限关联起来。

投入生产后，可在`SSO`应用上配置新的角色，并且手动关系新角色对应的权限。

#### 定义用户以及用户对应的角色
在`SSO`应用上，创建新用户，赋予相应的角色。相当于完成了对用户配置菜单和权限的操作。
因为通过角色，可以获取到这个用户所有的菜单和权限信息。

#### 如何获取菜单
- 元数据定义平台定义不同应用的菜单JSON文件
- 部署SSO应用的时候，自动将菜单JSON文件一起打包到容器中
- `SSO`应用提供获取菜单的接口 `/Api/SystemMenu/getMenus/{appName}`，根据 `appName` 区分具体想获取的是哪个应用的菜单，值为空时默认获取所有应用的菜单
- 根据当前用户拥有的菜单权限进行过滤，返回实际拥有的菜单

#### 如何进行 URL 合法性验证
这一步操作是在每个后端应用的拦截器中完成的。
- 后端应用启动的时候，根据元数据定义平台上的元数据，生成菜单和访问路径的 Mapping，并且将 Mapping 写进内存中。
- 客户端发起请求时，将在哪个菜单下访问的标示传递给服务器。将 MenuCode(ProcessSubMenuId) 放在 HttpHeader 中，与请求绑定在一起。
- 根据菜单和访问路径的 Mapping，检查本次请求的 Url 是否匹配当前菜单，如果不匹配，提示无权访问。

#### 如何对返回数据进行权限筛选
